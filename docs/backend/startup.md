# 启动流程

## 启动顺序

后端启动严格按照以下顺序执行，确保依赖关系正确：

```
┌─────────────────────────────────────────────────┐
│ 1. runSeeds()                                   │
│    数据库表自动同步 + 种子数据初始化               │
│    17 个种子按依赖顺序执行                        │
└────────────────────┬────────────────────────────┘
                     ↓
┌─────────────────────────────────────────────────┐
│ 2. sessionStore.init()                          │
│    从数据库加载未过期的 Session 到内存             │
└────────────────────┬────────────────────────────┘
                     ↓
┌─────────────────────────────────────────────────┐
│ 3. rbacService.init()                           │
│    全量预热 RBAC 缓存：                          │
│    Role + Permission + PermScope +               │
│    RolePermission + RoleMenu + Menu              │
│    权限向上汇聚（父角色 = 自身 ∪ 后代权限）        │
└────────────────────┬────────────────────────────┘
                     ↓
┌─────────────────────────────────────────────────┐
│ 4. dictService.initCache()                      │
│    字典全量缓存到内存                             │
└────────────────────┬────────────────────────────┘
                     ↓
┌─────────────────────────────────────────────────┐
│ 5. configService.initCache()                    │
│    系统参数配置缓存到内存                         │
└────────────────────┬────────────────────────────┘
                     ↓
┌─────────────────────────────────────────────────┐
│ 6. rateLimitRuleService.initCache()             │
│    限流规则缓存，按优先级排序                      │
└────────────────────┬────────────────────────────┘
                     ↓
┌─────────────────────────────────────────────────┐
│ 7. crudRegistry.initFromDb()                    │
│    从 CrudTable 加载动态表配置                    │
│    解析 columns JSON → 动态建表 → 注册服务        │
└────────────────────┬────────────────────────────┘
                     ↓
┌─────────────────────────────────────────────────┐
│ 8. jobService.start()                           │
│    加载所有启用的 Job → 注册 Cron 调度             │
└────────────────────┬────────────────────────────┘
                     ↓
┌─────────────────────────────────────────────────┐
│ 9. Elysia.listen(3000)                          │
│    构建 Elysia 应用 → 挂载中间件和路由 → 监听     │
└─────────────────────────────────────────────────┘
```

## 种子执行顺序

种子模块按依赖关系排序执行：

```
role                → 角色（超级管理员/普通用户等）
permission          → 权限编码
menu                → 菜单配置（目录/菜单/按钮）
user                → 默认用户（admin）
role-permission     → 角色-权限关联
role-menu           → 角色-菜单关联
permission-scope    → 权限数据范围规则
vip-tier            → VIP 等级
vip-resource-limit  → VIP 资源限制
dict                → 字典类型和数据
config              → 系统参数
notice              → 通知公告
job                 → 定时任务
rate-limit          → 限流规则
crud-table          → 动态 CRUD 表
```

每个种子通过 `SeedLog` 表记录执行状态，避免重复执行。支持在管理端手动触发重新执行。

## 缓存策略

| 缓存 | 存储 | 更新时机 |
|------|------|----------|
| Session | 内存 Map | 登录/登出/过期清理（1min 定时） |
| RBAC | 内存 Map | 角色/权限/菜单变更时全量刷新 |
| Dict | 内存 Map | 字典数据变更时全量刷新 |
| Config | 内存 Map | 参数变更时全量刷新 |
| RateLimit | 内存 Map | 规则变更时全量刷新 |
| CrudRegistry | 内存 Map | CRUD 表配置变更时刷新 |
